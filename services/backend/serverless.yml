service: invenadro-backend

frameworkVersion: '3'

plugins:
  - serverless-dotenv-plugin
  - serverless-iam-roles-per-function

# Configuraci贸n personalizada por ambiente
custom:
  # Configuraci贸n de Databricks (desde par谩metros de deploy)
  databricks:
    workspaceUrl: ${param:DATABRICKS_WORKSPACE_URL, ''}
    accessToken: ${param:DATABRICKS_ACCESS_TOKEN, ''}
    warehouseId: ${param:DATABRICKS_WAREHOUSE_ID, ''}
    orgId: ${param:DATABRICKS_ORG_ID, ''}

  #  URLs permitidas para CORS por ambiente
  allowedOrigins:
    # Para jul-dev: URL se sincroniza autom谩ticamente con script
    jul-dev: 'http://invenadro-frontend-jul-dev.s3-website.mx-central-1.amazonaws.com,http://localhost:3000,http://127.0.0.1:3000'
    # Para jul-qa, nadro-qa, nadro-prod: Se construyen din谩micamente
    jul-qa: 'http://invenadro-frontend-jul-qa.s3-website.mx-central-1.amazonaws.com,http://localhost:3000,http://127.0.0.1:3000'
    nadro-qa: 'http://invenadro-frontend-nadro-qa.s3-website.mx-central-1.amazonaws.com,http://localhost:3000'
    nadro-prod: 'http://invenadro-frontend-nadro-prod.s3-website.mx-central-1.amazonaws.com'
  
  # Configuraci贸n de Auth (siempre Cognito en AWS)
  auth:
    default:
      type: COGNITO_USER_POOLS
      authorizerId: !Ref ApiGatewayAuthorizer

package:
  individually: false
  patterns:
    - '!.git/**'
    - '!.github/**'
    - '!.vscode/**'
    - '!*.md'
    - '!.env*'
    - 'node_modules/**'
    - 'functions/**'
    - 'functionsCRUDConfiguracion/**' # Incluir CRUD
    - 'functionsIPP/**' # Incluir IPP
    - 'optimization/**'
    - 'rules/**'
    - 'utils/**'
    - 'data/**'
    - 'shared/**' # Incluir c贸digo compartido

provider:
  name: aws
  runtime: nodejs20.x
  region: mx-central-1
  stage: ${opt:stage, 'dev'}
  configValidationMode: warn  # Permite regiones custom como mx-central-1
  
  # Configuraci贸n de logs
  logs:
    restApi: true
  
  #  Clave KMS customer-managed para encriptar variables de entorno
  kmsKeyArn: !GetAtt LambdaKMSKey.Arn
  
  # Tags globales
  tags:
    Project: invenadro
    Service: simplicidad
    Stage: ${self:provider.stage}
    ManagedBy: serverless
  
  # Variables de entorno globales para todas las Lambdas
  environment:
    STAGE: ${self:provider.stage}
    SERVICE_NAME: ${self:service}
    AWS_NODEJS_CONNECTION_REUSE_ENABLED: '1'
    JOBS_TABLE: ${self:service}-${self:provider.stage}-jobs
    UPLOADS_BUCKET: ${self:service}-${self:provider.stage}-uploads
    RESULTS_BUCKET: ${self:service}-${self:provider.stage}-results
    STEP_FUNCTION_ARN: !Sub "arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:${self:service}-${self:provider.stage}-StateMachine"
    # URLs permitidas para CORS (separadas por coma)
    ALLOWED_ORIGINS: ${self:custom.allowedOrigins.${self:provider.stage}}
    # Databricks (disponible para todas las funciones que lo requieran)
    DATABRICKS_WORKSPACE_URL: ${self:custom.databricks.workspaceUrl}
    DATABRICKS_ACCESS_TOKEN: ${self:custom.databricks.accessToken}
    DATABRICKS_WAREHOUSE_ID: ${self:custom.databricks.warehouseId}
    DATABRICKS_ORG_ID: ${self:custom.databricks.orgId}

# Funciones Lambda
functions:
  initiator:
    name: ${self:service}-${self:provider.stage}-initiator
    handler: functions/initiator/index.handler
    timeout: 300
    memorySize: 512
    environment:
      PROCESSOR_STEP_FUNCTION_ARN: !Sub "arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:${self:service}-${self:provider.stage}-StateMachine"
    iamRoleStatements:
      - Effect: Allow
        Action:
          - states:StartExecution
        Resource: !Sub "arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:${self:service}-${self:provider.stage}-StateMachine"
      - Effect: Allow
        Action:
          - dynamodb:PutItem
          - dynamodb:GetItem
          - dynamodb:UpdateItem
        Resource: !GetAtt JobsTable.Arn
      - Effect: Allow
        Action:
          - s3:GetObject
          - s3:PutObject
        Resource:
          - !Sub "${UploadsBucket.Arn}/*"
    events:
      - http:
          path: /calcular-redondeo
          method: post
          cors: true
          authorizer: ${self:custom.auth.default}

  getPresignedUrl:
    name: ${self:service}-${self:provider.stage}-get-presigned-url
    handler: functions/get-presigned-url/index.handler
    timeout: 30
    memorySize: 256
    iamRoleStatements:
      - Effect: Allow
        Action:
          - s3:PutObject
        Resource:
          - !Sub "${UploadsBucket.Arn}/*"
    events:
      - http:
          path: /get-presigned-url
          method: post
          cors: true
          authorizer: ${self:custom.auth.default}

  statusChecker:
    name: ${self:service}-${self:provider.stage}-status-checker
    handler: functions/status-checker/index.handler
    timeout: 30
    memorySize: 256
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:UpdateItem
        Resource: !GetAtt JobsTable.Arn
      - Effect: Allow
        Action:
          - states:DescribeExecution
        Resource: !Sub "arn:aws:states:${AWS::Region}:${AWS::AccountId}:stateMachine:${self:service}-${self:provider.stage}-StateMachine"
    events:
      - http:
          path: /status/{processId}
          method: get
          cors: true
          authorizer: ${self:custom.auth.default}

  clientSeparator:
    name: ${self:service}-${self:provider.stage}-client-separator
    handler: functions/client-separator/index.handler
    timeout: 900
    memorySize: 1024
    iamRoleStatements:
      - Effect: Allow
        Action:
          - s3:GetObject
          - s3:PutObject
        Resource:
          - !Sub "${UploadsBucket.Arn}/*"
          - !Sub "${ResultsBucket.Arn}/*"
      - Effect: Allow
        Action:
          - dynamodb:UpdateItem
        Resource: !GetAtt JobsTable.Arn

  processor:
    name: ${self:service}-${self:provider.stage}-processor
    handler: functions/processor/index.handler
    timeout: 900
    memorySize: 2048
    iamRoleStatements:
      - Effect: Allow
        Action:
          - s3:GetObject
          - s3:PutObject
        Resource:
          - !Sub "${UploadsBucket.Arn}/*"
          - !Sub "${ResultsBucket.Arn}/*"
      - Effect: Allow
        Action:
          - ssm:GetParameters
        Resource: 
          - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/invenadro/databricks/*"
      - Effect: Allow
        Action:
          - kms:Decrypt
        Resource: !GetAtt LambdaKMSKey.Arn
      - Effect: Allow
        Action:
          - dynamodb:UpdateItem
          - dynamodb:GetItem
          - dynamodb:PutItem
        Resource: !GetAtt JobsTable.Arn

  clientAggregator:
    name: ${self:service}-${self:provider.stage}-client-aggregator
    handler: functions/client-aggregator/index.handler
    timeout: 900
    memorySize: 1024
    iamRoleStatements:
      - Effect: Allow
        Action:
          - s3:GetObject
          - s3:PutObject
        Resource:
          - !Sub "${ResultsBucket.Arn}/*"
      - Effect: Allow
        Action:
          - dynamodb:UpdateItem
        Resource: !GetAtt JobsTable.Arn

  downloadResult:
    name: ${self:service}-${self:provider.stage}-download-result
    handler: functions/download-result/index.handler
    timeout: 30
    memorySize: 512
    iamRoleStatements:
      - Effect: Allow
        Action:
          - s3:GetObject
        Resource:
          - !Sub "${ResultsBucket.Arn}/*"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:UpdateItem
        Resource: !GetAtt JobsTable.Arn
    events:
      - http:
          path: /download/{processId}
          method: get
          cors: true
          authorizer: ${self:custom.auth.default}

  excelGenerator:
    name: ${self:service}-${self:provider.stage}-excel-generator
    handler: functions/excel-generator/index.handler
    timeout: 60
    memorySize: 1024
    environment:
      JOBS_TABLE: !Ref JobsTable
    iamRoleStatements:
      - Effect: Allow
        Action:
          - s3:GetObject
          - s3:ListBucket
        Resource:
          - !Sub "${ResultsBucket.Arn}"
          - !Sub "${ResultsBucket.Arn}/*"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
        Resource: !GetAtt JobsTable.Arn
    events:
      - http:
          path: /excel/{processId}/{clienteId}
          method: get
          cors: true
          authorizer: ${self:custom.auth.default}

  # ===================================================================================
  # CRUD DE CONFIGURACIONES (Databricks)
  # ===================================================================================
  
  createConfig:
    name: ${self:service}-${self:provider.stage}-create-config
    handler: functionsCRUDConfiguracion/create-config/index.handler
    timeout: 30
    memorySize: 256
    package:
      individually: true
      patterns:
        - '!functionsCRUDConfiguracion/**'
        - '!functions/**'
        - '!.git/**'
        - '!.github/**'
        - '!.vscode/**'
        - '!*.md'
        - 'functionsCRUDConfiguracion/create-config/**'
        - 'shared/**'
        - 'node_modules/**'
    # Variables de entorno heredadas globalmente (Databricks)
    events:
      - http:
          path: /configuraciones
          method: post
          cors: true
          authorizer: ${self:custom.auth.default}

  readConfig:
    name: ${self:service}-${self:provider.stage}-read-config
    handler: functionsCRUDConfiguracion/read-config/index.handler
    timeout: 30
    memorySize: 256
    package:
      individually: true
      patterns:
        - '!functionsCRUDConfiguracion/**'
        - '!functions/**'
        - '!.git/**'
        - '!.github/**'
        - '!.vscode/**'
        - '!*.md'
        - 'functionsCRUDConfiguracion/read-config/**'
        - 'shared/**'
        - 'node_modules/**'
    events:
      - http:
          path: /configuraciones
          method: get
          cors: true
          authorizer: ${self:custom.auth.default}
      - http:
          path: /configuraciones/{mostradorId}
          method: get
          cors: true
          authorizer: ${self:custom.auth.default}

  updateConfig:
    name: ${self:service}-${self:provider.stage}-update-config
    handler: functionsCRUDConfiguracion/update-config/index.handler
    timeout: 30
    memorySize: 256
    package:
      individually: true
      patterns:
        - '!functionsCRUDConfiguracion/**'
        - '!functions/**'
        - '!.git/**'
        - '!.github/**'
        - '!.vscode/**'
        - '!*.md'
        - 'functionsCRUDConfiguracion/update-config/**'
        - 'shared/**'
        - 'node_modules/**'
    events:
      - http:
          path: /configuraciones/{mostradorId}
          method: put
          cors: true
          authorizer: ${self:custom.auth.default}

  deleteConfig:
    name: ${self:service}-${self:provider.stage}-delete-config
    handler: functionsCRUDConfiguracion/delete-config/index.handler
    timeout: 30
    memorySize: 256
    package:
      individually: true
      patterns:
        - '!functionsCRUDConfiguracion/**'
        - '!functions/**'
        - '!.git/**'
        - '!.github/**'
        - '!.vscode/**'
        - '!*.md'
        - 'functionsCRUDConfiguracion/delete-config/**'
        - 'shared/**'
        - 'node_modules/**'
    events:
      - http:
          path: /configuraciones/{mostradorId}
          method: delete
          cors: true
          authorizer: ${self:custom.auth.default}

  # ===================================================================================
  # MDULO IPP (Inventario de Precisi贸n Predictiva)
  # ===================================================================================
  
  ippVerificador:
    name: ${self:service}-${self:provider.stage}-ipp-verificador
    handler: functionsIPP/ipp-verificador/index.handler
    timeout: 60
    memorySize: 512
    environment:
      IPP_JOBS_TABLE: !Ref IPPJobsTable
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:Query
        Resource: !GetAtt IPPJobsTable.Arn
    events:
      - http:
          path: /ipp/validate-clients
          method: post
          cors: true
          authorizer: ${self:custom.auth.default}
  
  ippIniciador:
    name: ${self:service}-${self:provider.stage}-ipp-iniciador
    handler: functionsIPP/ipp-iniciador/index.handler
    timeout: 60
    memorySize: 512
    environment:
      IPP_JOBS_TABLE: !Ref IPPJobsTable
      IPP_RAW_BUCKET: !Ref IPPRawBucket
      DATABRICKS_JOB1_ID: ${param:DATABRICKS_IPP_JOB1_ID, ''}
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:PutItem
          - dynamodb:GetItem
        Resource: !GetAtt IPPJobsTable.Arn
      - Effect: Allow
        Action:
          - s3:PutObject
        Resource: !Sub "${IPPRawBucket.Arn}/*"
    events:
      - http:
          path: /ipp/start
          method: post
          cors: true
          authorizer: ${self:custom.auth.default}
  
  ippStatus:
    name: ${self:service}-${self:provider.stage}-ipp-status
    handler: functionsIPP/ipp-status/index.handler
    timeout: 30
    memorySize: 256
    environment:
      IPP_JOBS_TABLE: !Ref IPPJobsTable
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:UpdateItem
        Resource: !GetAtt IPPJobsTable.Arn
    events:
      - http:
          path: /ipp/status/{job_id}
          method: get
          cors: true
          authorizer: ${self:custom.auth.default}
  
  ippResults:
    name: ${self:service}-${self:provider.stage}-ipp-results
    handler: functionsIPP/ipp-results/index.handler
    timeout: 30
    memorySize: 256
    environment:
      IPP_JOBS_TABLE: !Ref IPPJobsTable
    iamRoleStatements:
      - Effect: Allow
        Action:
          - dynamodb:GetItem
        Resource: !GetAtt IPPJobsTable.Arn
    events:
      - http:
          path: /ipp/results/{job_id}
          method: get
          cors: true
          authorizer: ${self:custom.auth.default}
  
  ippDownloadUrl:
    name: ${self:service}-${self:provider.stage}-ipp-download-url
    handler: functionsIPP/ipp-download-url/index.handler
    timeout: 30
    memorySize: 256
    iamRoleStatements:
      - Effect: Allow
        Action:
          - s3:GetObject
        Resource:
          - !Sub "${ResultsBucket.Arn}/*"
          - !Sub "${IPPRawBucket.Arn}/*"
    events:
      - http:
          path: /ipp/download-url
          method: post
          cors: true
          authorizer: ${self:custom.auth.default}
  
  ippToFactorBridge:
    name: ${self:service}-${self:provider.stage}-ipp-to-factor-bridge
    handler: functionsIPP/ipp-to-factor-bridge/index.handler
    timeout: 900  # 15 minutos (para procesar m煤ltiples clientes)
    memorySize: 1024
    environment:
      IPP_JOBS_TABLE: !Ref IPPJobsTable
      UPLOADS_BUCKET: !Ref UploadsBucket
      INITIATOR_FUNCTION_NAME: ${self:service}-${self:provider.stage}-initiator
    iamRoleStatements:
      - Effect: Allow
        Action:
          - s3:GetObject
        Resource:
          - !Sub "${IPPRawBucket.Arn}/*"
      - Effect: Allow
        Action:
          - s3:PutObject
        Resource:
          - !Sub "${UploadsBucket.Arn}/*"
      - Effect: Allow
        Action:
          - lambda:InvokeFunction
        Resource: !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${self:service}-${self:provider.stage}-initiator"
      - Effect: Allow
        Action:
          - dynamodb:UpdateItem
        Resource: !GetAtt IPPJobsTable.Arn
  
  factorCompletionCallback:
    name: ${self:service}-${self:provider.stage}-factor-completion-callback
    handler: functionsIPP/factor-completion-callback/index.handler
    timeout: 60
    memorySize: 256
    environment:
      IPP_JOBS_TABLE: !Ref IPPJobsTable
    iamRoleStatementsName: invenadro-${self:provider.stage}-factor-cb-role
    iamRoleStatements:
      - Effect: Allow
        Action:
          - s3:GetObject
        Resource:
          - !Sub "${ResultsBucket.Arn}/*"
      - Effect: Allow
        Action:
          - dynamodb:GetItem
          - dynamodb:UpdateItem
        Resource: !GetAtt IPPJobsTable.Arn

# Recursos adicionales (DynamoDB, S3, IAM, Cognito)
resources:
  - ${file(resources/dynamodb.yml)}
  - ${file(resources/s3.yml)}
  - ${file(resources/iam.yml)}
  - ${file(resources/cognito.yml)}
  - ${file(resources/kms.yml)}
  - ${file(resources/api-gateway.yml)}
  - ${file(resources/api-gateway-role.yml)}
  - ${file(resources/step-functions.yml)}
  - ${file(resources/ipp-resources.yml)}
  - ${file(resources/outputs.yml)}
