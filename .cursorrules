# Reglas del Proyecto - Factor de Redondeo

## Comunicación
- **SIEMPRE responder en español**
- Usar terminología técnica en español cuando sea apropiado
- Mantener código y comentarios en inglés según convenciones de programación

## Descripción del Proyecto
Sistema de optimización de Factor de Redondeo para gestión de inventarios, implementado con arquitectura serverless en AWS.

## Arquitectura Técnica

### Stack Principal
- **AWS Lambda**: Procesamiento serverless
- **AWS Step Functions**: Orquestación de workflows (step-function-v35.json)
- **AWS S3**: Almacenamiento de archivos Excel y resultados
- **AWS DynamoDB**: Base de datos NoSQL para tracking de procesos
- **API Gateway**: Endpoints REST para el frontend
- **React**: Frontend (FrontEnd-lambdas/)

### ⚠️ IMPORTANTE: NO hay integración con Databricks
El sistema funciona 100% con servicios AWS. No usar ni mencionar credenciales o servicios de Databricks.

## Componentes Lambda

### 1. lambda-initiator
- Punto de entrada del proceso
- Recibe archivo Excel del frontend
- Inicia Step Function

### 2. lambda-client-separator
- Separa datos por cliente
- Genera archivos individuales en S3
- Prepara ejecuciones paralelas

### 3. lambda-processor
- **Motor principal de optimización**
- Archivos clave:
  - `index.js`: Orquestador principal
  - `invenadroCalc_modular.js`: Lógica de cálculo y optimización
  - `optimization/factorOptimizer.js`: Algoritmo de optimización
  - `optimization/calculationEngine.js`: Motor de cálculos
  
### 4. lambda-status-checker
- Monitorea estado de ejecuciones paralelas
- **CRÍTICO**: Incluye lógica `MULTI_CLIENT_MONITORING` (líneas 23-26, 108-172)
- Retorna: `{allCompleted, hasErrors, totalExecutions, completedCount, failedCount, runningCount, executionStatuses}`

### 5. lambda-client-aggregator
- Consolida resultados de múltiples clientes
- Agrega datos para vista general

### 6. lambda-download-result
- Genera respuesta para API Gateway
- **Línea 130**: Incluye `convergenciaData: resultado.convergenciaData || []`

### 7. lambda-excel-generator
- Genera Excel individual por cliente on-demand
- Endpoint: `https://8zck1369x8.execute-api.us-east-1.amazonaws.com/dev/excel/{processId}/{clienteId}`

## Frontend (FrontEnd-lambdas/)

### Estructura
```
src/
├── App.js                    # Componente principal
├── App.css                   # Estilos globales
├── components/              # Componentes reutilizables
│   ├── ConvergenceModal.js  # Modal de convergencia
│   ├── AdvancedClientTable.js
│   └── ...
├── services/
│   └── lambdaService.js     # Cliente API
├── hooks/
│   ├── useFileUpload.js
│   └── useProcessing.js
└── constants/
    ├── config.js
    └── processStates.js
```

### Implementaciones Clave

#### Modal de Convergencia por Cliente
- **Componente**: `ConvergenceModal.js`
- **Datos**: `result.convergenciaData` (NO `result.optimizacion.historialIteraciones`)
- **Backend**: 
  - `lambda-processor/invenadroCalc_modular.js` línea 705: retorna `convergenciaData: historialIteraciones`
  - Cuando `factorForzado` está activo: `historialIteraciones = []` (líneas 246, 569)
  - `procesarExcelConConfiguracion` línea 421: retorna `convergenciaData: historialIteraciones || []`
- **Frontend**: Botón con `FaChartLine` (línea 488) en `App.js`

#### Descarga Individual de Excel por Cliente
- **Estado**: `downloadingClients` (Set) para tracking
- **Estado**: `toasts` (array) para notificaciones
- **Función**: `handleDownloadClient` 
  - Descarga Base64
  - Convierte a ArrayBuffer usando dataUrl + fetch
  - Crea blob y descarga
- **Botón**: `className="download-btn-custom"` con spinner `FaSpinner`
- **CSS** (App.css líneas 338-373):
  - `.download-btn-custom`: transparente, borde verde
  - `.download-btn-custom:hover`: fondo verde, ícono blanco
  - `.download-btn-custom:disabled`: fondo verde opacity 0.8
- **Service**: `lambdaService.downloadClientExcel()` devuelve Base64 usando `response.text()`

#### Tabs en App.js
- Tab "Resumen" fue removido
- Solo existe tab "Detalles por Cliente"

## Flujo de Datos

### Convergencia
```
lambda-processor/invenadroCalc_modular.js (línea 705)
  ↓ convergenciaData: historialIteraciones
lambda-processor/index.js (línea 85)
  ↓ convergenciaData: resultado.convergenciaData || []
S3 (almacenamiento)
  ↓
lambda-download-result/index.js (línea 130)
  ↓ convergenciaData: resultado.convergenciaData || []
API Gateway
  ↓
FrontEnd → ConvergenceModal.js
  ↓ result.convergenciaData
Chart.js (visualización)
```

### Step Function v35
- **Estado crítico**: "EvaluarEstadoProcesos"
- **Path requerido**: `$.monitoringResult.Payload.allCompleted`
- **Fix aplicado**: lambda-status-checker con lógica `MULTI_CLIENT_MONITORING`

## Convenciones de Código

### JavaScript/Node.js
- Usar `async/await` para operaciones asíncronas
- Manejo de errores con try-catch
- Logging consistente en lambdas
- Nombres de variables en camelCase
- Constantes en UPPER_SNAKE_CASE

### React
- Componentes funcionales con hooks
- Estados locales con `useState`
- Efectos con `useEffect`
- Custom hooks en carpeta `hooks/`
- Separación de lógica de negocio en services

### CSS
- Clases con nombres descriptivos
- Usar `-custom` suffix para estilos específicos (ej: `download-btn-custom`)
- Hover states para interactividad
- Disabled states con opacity

### AWS Lambda
- Retornar siempre statusCode y body
- Body como JSON.stringify para API Gateway
- Incluir headers CORS cuando sea necesario
- Usar AWS SDK v3 (@aws-sdk/*)

## Deployment

### Lambda
```bash
# Empaquetar lambda
zip -r lambda-name.zip . -x "*.git*" "*.zip"

# Desplegar
aws lambda update-function-code \
  --function-name factor-redondeo-lambda-dev-{name} \
  --zip-file fileb://lambda-name.zip
```

### Frontend
```bash
cd FrontEnd-lambdas
npm run build
# Desplegar build/ a S3 o hosting
```

## Dependencias Importantes

### Backend (Lambda)
- `@aws-sdk/client-s3` - Operaciones S3
- `@aws-sdk/client-dynamodb` - DynamoDB
- `@aws-sdk/client-sfn` - Step Functions (en lambda-status-checker)
- `xlsx` - Lectura/escritura Excel
- `mathjs` - Cálculos matemáticos

### Frontend
- `react` - Framework UI
- `chart.js` + `react-chartjs-2` - Gráficas de convergencia
- `react-icons` - Iconos (FaChartLine, FaSpinner, etc.)
- `axios` - HTTP client

## Testing
- Usar Postman con archivos `postman_import_curl.txt` y `postman_payload.json`
- Script bash: `test_curl.sh`
- Verificar logs en CloudWatch

## Debugging Tips
1. **Convergencia vacía**: Verificar si `factorForzado` está activo
2. **Step Function falla**: Revisar lambda-status-checker con lógica MULTI_CLIENT_MONITORING
3. **Descarga Excel falla**: Verificar formato Base64 y conversión a ArrayBuffer
4. **CORS errors**: Verificar headers en lambda responses

## Archivos a Ignorar
- `App_BACKUP_*.js`, `App_OLD.js`, `App_NEW.js` - Backups antiguos
- `*.zip` - Builds de lambda
- `node_modules/` - Dependencias

## Links Importantes
- API Excel Generator: `https://8zck1369x8.execute-api.us-east-1.amazonaws.com/dev/excel/{processId}/{clienteId}`

## Notas de Desarrollo
- Preferir ediciones sobre archivos existentes vs crear nuevos
- Verificar que los cambios no rompan el flujo del Step Function
- Probar cambios con datos reales en ambiente dev
- Mantener consistencia en manejo de errores entre lambdas
